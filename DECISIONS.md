# 关键决策记录

## 时间规范
- 所有时间戳必须使用北京时间（东八区）
- 时间格式应为：YYYY-MM-DD HH:MM:SS
- 必须通过互联网获取准确的北京时间（例如：中国国家授时中心、北京时间网站等）
- 所有决策记录需精确到秒

## 2025-03-18
### 1. 项目架构决策
- 决策：采用模块化设计
- 原因：便于维护、测试和扩展
- 具体实现：
  - 数据获取模块
  - 数据存储模块
  - 因子生成模块
  - 策略模块
  - 回测模块
  - 交易执行模块
  - 监控模块

### 2. 数据存储方案
- 决策：使用CSV文件存储
- 原因：
  - 开发初期数据量可控
  - 便于调试和验证
  - 实现简单快速
- 迁移计划：后期根据数据量增长情况考虑迁移到数据库

### 3. 交易框架选择
- 决策：选择vnpy
- 原因：
  - 对加密货币支持完善
  - 持续维护更新
  - 功能全面
  - 实盘交易成熟
  - 中文社区支持好

### 4. 因子开发方案
- 决策：采用混合开发方案
- 具体方案：
  - vnpy负责：
    - 数据获取
    - 实盘交易
    - 风控管理
    - 策略执行
  - 自建模块负责：
    - 因子计算
    - 因子评价
    - 因子组合
    - 多因子模型
- 原因：
  - 充分利用vnpy的交易功能
  - 保持因子研究的灵活性
  - 便于维护和扩展
  - 可以引入专业因子库

### 5. 开发优先级
1. 数据获取和存储
2. 因子研究框架
3. 回测系统
4. 实盘交易系统
5. 监控系统

### 7. 数据获取完善方案
- 决策：实现全时间周期数据获取
- 具体方案：
  - 支持所有标准时间周期
  - 采用分段下载策略
  - 实现按月存储机制
- 原因：
  - 便于后续因子研究使用不同周期数据
  - 避免单次请求数据量过大
  - 便于数据管理和更新

### 8. 数据存储结构决策
- 决策：按时间周期和月份分文件存储
- 具体方案：
  - 目录结构：data/kline/
  - 文件命名：{symbol}_{interval}_{YYYYMM}.csv
  - 数据格式：timestamp,open,high,low,close,volume
- 原因：
  - 便于按需读取特定时间段数据
  - 避免单文件过大
  - 支持并行处理
  - 便于数据更新和维护

### 8. 符号回归因子挖掘方案（17:45更新）
- 决策：实现自动因子发现功能
- 具体方案：
  - 使用遗传算法进行符号回归
  - 支持多种数学运算符和统计函数
  - 完整的因子评估体系
- 原因：
  - 无需人工预设技术指标
  - 可以发现非线性关系
  - 评估体系全面

## 2025-03-19
### 9. 路径适配方案
- 决策：将所有硬编码绝对路径改为相对路径
- 具体方案：
  - 使用Path(__file__).parent获取当前文件位置
  - 通过相对关系确定项目根目录
  - 所有文件路径基于项目根目录构建
- 原因：
  - 提高代码可移植性
  - 支持在不同计算机上运行
  - 避免环境依赖问题

### 10. 参数网格搜索方案
- 决策：开发自动化参数搜索系统
- 具体方案：
  - 实现FactorGridSearch类
  - 定义参数搜索空间（预测周期、种群大小、代数等）
  - 使用综合评分进行因子评价
  - 生成详细搜索报告
- 原因：
  - 大量参数组合需要系统化测试
  - 手动调整参数耗时且不全面
  - 数据驱动的参数选择更科学
  - 需要可复现的评估过程

### 11. 因子评价指标体系
- 决策：采用综合评分机制
- 具体公式：score = |IC| * 稳定性 * (做多收益 + 做空收益) / 复杂度
- 组成部分：
  - IC(信息系数)：衡量与未来收益相关性
  - 稳定性：衡量因子的时间一致性
  - 收益能力：包括做多和做空方向
  - 复杂度惩罚：避免过拟合
- 原因：
  - 单一指标无法全面评价因子质量
  - 平衡预测能力和稳定性
  - 考虑实际交易收益
  - 偏好简单且有效的因子

### 12. 符号回归因子挖掘器参数优化方案 (2025-03-19 14:30:45)
- 决策：修改遗传算法配置，解决早停问题
- 具体方案：
  - 移除`metric='spearman'`参数，避免与`stopping_criteria`冲突
  - 设置`stopping_criteria=0.001`作为合理的早停阈值
  - 在适应度评估中使用绝对值`abs()`处理，避免负值判断问题
  - 保留`early_stopping=30`设置，支持连续30代无改善时停止
- 原因：
  - gplearn库的遗传算法实现中存在隐含行为，某些参数组合会导致提前终止
  - 需要平衡计算效率和搜索质量
  - 避免因不合理参数设置导致算法过早停止或过度计算
  - 确保因子挖掘过程能够充分发挥遗传算法优势
  - 参数之间存在相互作用，需要系统调整

### 13. 随机种子策略调整 (2025-03-19 15:20:18)
- 决策：为重要测试运行保留固定随机种子，网格搜索考虑使用动态种子
- 具体方案：
  - 测试用例使用固定随机种子`random_state=42`，保证结果可复现
  - 考虑在网格搜索中添加随机种子变化选项
  - 实现随机种子影响分析功能
- 原因：
  - 固定随机种子保证测试结果一致性和可复现性
  - 动态随机种子有助于探索更广泛的解空间
  - 平衡可复现性和搜索广度的需求

## 2025-03-20
### 14. 符号回归安全函数实现 (2025-03-20 10:15:30)
- 决策：实现数学安全函数库解决无效表达式问题
- 具体方案：
  - 添加`_safe_log`、`_safe_div`、`_safe_sqrt`等安全函数
  - 将函数集替换为安全函数集
  - 在评估函数中添加无效值检测与惩罚
  - 实现多随机种子策略提高搜索广度
- 原因：
  - 解决`log(-1.001)`等无效数学表达式问题
  - 避免NaN和Inf值导致的评估失败
  - 增加搜索空间多样性
  - 提高最终因子的数学合理性和有效性

### 10:15
- 解决符号回归因子挖掘无效表达式问题：
  - 问题：算法生成无效数学表达式如`log(-1.001)`
  - 问题影响：导致评估过程中出现NaN值，影响因子质量
  - 解决方案：
    1. 实现数学安全函数库
    2. 对无效值进行检测和惩罚
    3. 增加变异率提高种群多样性
    4. 实现多随机种子策略

- 优化SymbolicFactorMiner类：
  - 增加变异参数控制：
    - p_crossover=0.65 (降低交叉概率)
    - p_subtree_mutation=0.25 (增加子树变异)
    - p_hoist_mutation=0.15 (增加提升变异)
    - p_point_mutation=0.15 (增加点变异)
  - 添加安全函数集合
  - 优化评估函数处理无效表达式
  - 实现多种子策略增加解空间探索

### 问题与解决方案
1. 问题：符号回归生成数学无效表达式
   - 解决：实现保护函数和数学安全函数库
   
2. 问题：算法过早收敛到简单表达式
   - 解决：
     - 增加变异率和多样性参数
     - 降低锦标赛选择压力(tournament_size=15)
     - 拓展初始深度范围(init_depth=(2, 6))

### 下一步计划
1. 运行网格搜索验证安全函数有效性
2. 分析不同参数组合对因子质量的影响
3. 考虑添加更多数学函数丰富表达能力
4. 实现因子组合策略

## 版本历史
- v0.1.0 (2025-03-18)
  - 项目初始化
  - 完成基础架构设计
  - 实现数据获取模块
  - 开发符号回归因子挖掘器
- v0.2.0 (2025-03-19)
  - 实现参数网格搜索功能
  - 改进因子评估系统
  - 优化数据处理路径适配
- v0.2.1 (2025-03-20)
  - 实现数学安全函数库
  - 优化符号回归变异参数
  - 添加多随机种子策略
  - 改进因子评估对无效值处理

## 系统架构
系统分为以下主要模块：

### 3. 因子研究模块 (factor_research)
- 技术指标计算
- 自定义因子生成
- 符号回归因子挖掘
  - 数学安全函数库
  - 多样化变异策略
  - 多随机种子探索
- 因子评估和筛选
- 参数网格搜索优化

# 1. 完全不同的搜索策略 - 在symbolic_miner.py中修改
self.regressor = SymbolicRegressor(
    # 基础参数
    population_size=8000,        # 大幅增加种群大小
    generations=400,             # 增加代数
    
    # 选择压力大幅降低
    tournament_size=5,           # 极小的锦标赛大小
    
    # 极大的变异率
    p_crossover=0.3,             # 大幅降低交叉概率
    p_subtree_mutation=0.3,      # 大幅增加子树变异
    p_hoist_mutation=0.2,        # 大幅增加提升变异
    p_point_mutation=0.2,        # 大幅增加点变异
    
    # 减少复杂度惩罚
    parsimony_coefficient=0.0001, # 几乎不惩罚复杂表达式
    
    # 强制使用随机种子
    random_state=int(time.time()), # 使用当前时间作为种子
    
    # 禁用早停
    stopping_criteria=0.0,       # 完全禁用早停
    early_stopping=None          # 禁用连续代数早停
)

### 配置系统重构决策
**问题**：配置参数分散在多个文件中，难以管理和维护。

**决策**：创建统一的配置管理系统。
- 将所有配置集中到 `factor_research/config/config.py`
- 按功能模块组织配置参数
- 提供向后兼容的接口

**理由**：
- 提高代码可维护性
- 减少配置冲突
- 便于参数调整和实验

### 网格搜索参数优化决策
**问题**：参数组合数量过多（270种），导致计算时间过长。

**决策**：优化参数范围和组合。
- 减少参数值数量
- 使用更大的步长
- 添加特殊组合探索中间值

**理由**：
- 提高搜索效率
- 保持参数覆盖范围
- 平衡计算资源和搜索效果

### 多进程支持决策
**问题**：网格搜索执行时间长，需要提高效率。

**决策**：实现多进程并行执行。
- 使用 Python multiprocessing
- 动态分配任务
- 实时进度显示

**理由**：
- 充分利用多核CPU
- 提高整体执行效率
- 保持代码可维护性

### 遗传算法参数决策
**问题**：需要确定遗传算法的关键参数。

**决策**：设置以下默认参数：
- population_size: 3000
- generations: 100
- tournament_size: 10
- early_stopping: 30
- stopping_criteria: 0.001

**理由**：
- 平衡计算资源和效果
- 考虑早停机制
- 参考相关研究经验

### 数据存储决策
**问题**：需要高效的数据存储方案。

**决策**：使用CSV格式存储K线数据。
- 按时间范围分文件存储
- 使用标准化的列名
- 实现增量更新

**理由**：
- 简单易用
- 便于调试和查看
- 支持增量更新

## 待决策事项
1. 因子评估指标的选择
2. 回测系统的设计
3. 风险控制策略
4. 性能优化方案
5. 部署架构选择