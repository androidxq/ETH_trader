# ETH 交易系统开发日志

## 开发规范
1. 所有代码文件使用绝对路径，基准目录：d:\pythonProject\ETH_trader
2. 代码文件命名采用小写字母，用下划线连接
3. 类名使用驼峰命名法
4. 函数和变量使用小写字母，用下划线连接
5. 所有文本文件使用 UTF-8 编码
6. 代码变更需要在开发日志中记录
7. 重要决策需要记录决策原因

## 文档更新规范
1. README.md 更新要求：
   - 项目结构变动时必须同步更新
   - 新增重要功能时需要更新相关模块说明
   - 技术栈变更时需要更新
   - 开发计划调整时需要更新

2. DEVLOG.md 更新要求：
   - 每次开发讨论后必须更新
   - 使用精确时间戳（准确到年月日时分秒，必须使用北京时间）
   - 使用格式：YYYY-MM-DD HH:MM:SS
   - 必须通过互联网获取准确的北京时间（东八区）
   - 记录所有重要决策和原因
   - 记录问题及解决方案
   - 记录新的想法和灵感
   - 及时更新待办事项状态

3. 配置文件更新要求：
   - 配置变更必须记录在开发日志中
   - 需要说明配置变更原因
   - 需要记录配置项的作用

## 2025-03-18
### 14:30
- 项目启动
- 确定项目整体架构，创建基础文件：
  - README.md：项目说明文档
  - DEVLOG.md：开发日志
- 确定主要模块划分：
  - 数据获取模块
  - 数据存储模块
  - 因子生成模块
  - 策略模块
  - 回测模块
  - 交易执行模块
  - 监控模块

### 15:00
- 技术决策：选择 CSV 作为初期数据存储方案
  - 原因：实现简单，开发速度快，数据直观
  - 后续计划：根据数据量增长情况考虑迁移到数据库

### 待办事项
- [ ] 实现数据获取模块
  - [ ] 确定需要获取的数据类型
  - [ ] 设计数据获取接口
  - [ ] 实现币安 API 连接
- [ ] 完善数据存储模块
  - [ ] 实现 CSV 存储类
  - [ ] 添加数据验证功能

### 问题与解决方案
1. 问题：如何选择合适的数据存储方案
   - 解决：初期使用 CSV，后期根据需求迁移到数据库

### 想法与灵感
1. 数据存储可以按月分文件，避免单个文件过大
2. 考虑添加数据完整性检查机制
3. 可以考虑添加数据压缩功能，节省存储空间

### 下一步计划
1. 开始实现数据获取模块
2. 设计具体的数据结构
3. 实现基础的数据存储功能

## 2024-01-24
### 19:00
- 完成历史数据下载：
  - 成功获取ETHUSDT永续合约所有时间周期数据
  - 数据时间范围：近2年
  - 数据存储格式：按月份CSV文件
  - 存储路径：d:/pythonProject/ETH_trader/data/kline/

- 数据获取细节：
  - 分段下载：每30天一段
  - 自动去重和排序
  - 支持增量更新
  - 完整时间周期覆盖：
    - 分钟级：1m, 3m, 5m, 15m, 30m
    - 小时级：1h, 2h, 4h, 6h, 8h, 12h
    - 日线级：1d

- 下一步计划：
  - [ ] 开发数据完整性检查工具
  - [ ] 实现数据定时更新机制
  - [ ] 开始因子研究框架开发
- 技术细节：
  - 支持的时间级别：
    - 分钟级：1m, 3m, 5m, 15m, 30m
    - 小时级：1h, 2h, 4h, 6h, 8h, 12h
    - 日线级：1d
  - 数据分段：每30天为一段
  - 请求间隔：0.5秒
  - 数据存储：按月份分文件存储

- 待办事项更新：
  - [x] 实现基础数据获取功能
  - [x] 添加多时间周期支持
  - [ ] 添加数据完整性验证
  - [ ] 实现实时数据更新功能
- [ ] 技术调研：量化交易框架对比
  1. Backtrader
     优势：
     - 使用简单，学习曲线平缓
     - 文档完善，社区活跃
     - 支持多种数据源
     - 回测速度适中
     - 支持实时交易
     缺点：
     - 不再积极维护
     - 性能一般，不适合高频

  2. QSTrader
     优势：
     - 专注于因子策略
     - 代码结构清晰
     - 性能较好
     缺点：
     - 社区相对较小
     - 文档不够完善
     - 功能相对简单

  3. vnpy
     优势：
     - 功能最为全面
     - 支持多种交易所
     - 有完整的GUI界面
     - 持续更新维护
     - 支持期货、股票等多品种
     缺点：
     - 学习曲线较陡
     - 系统较重
     - 回测速度一般

### 技术决策
- 初步倾向选择 vnpy 框架，原因：
  1. 对加密货币交易支持完善
  2. 持续维护更新，稳定性好
  3. 功能全面，便于后期扩展
  4. 有完整的实盘交易功能
  5. 中文社区活跃，文档齐全

## 2025-03-19
### 10:30
- 解决路径适配问题：
  - 问题：硬编码的绝对路径导致在不同计算机上无法运行
  - 解决方案：修改所有代码使用相对路径，基于项目根目录
  - 影响范围：数据加载、存储和测试脚本
  
- 测试符号回归因子挖掘：
  - 使用5分钟K线数据进行因子挖掘
  - 结果分析：单月数据结果良好，全部数据结果退化
  - 原因分析：市场特性在两年内可能发生了显著变化
  
### 13:45
- 开发参数网格搜索功能：
  - 目标：自动化寻找最佳参数组合
  - 实现：`grid_search_factors.py`脚本
  - 参数网格：
    - forward_period: [12, 24, 36, 48, 60, 72, 84, 96, 120]
    - generations: [100, 200, 300, 400, 500]
    - population_size: [3000, 5000]
    - tournament_size: [20, 25, 30]
  - 评估指标：综合得分 = |IC| * 稳定性 * (做多收益 + 做空收益) / 复杂度
  
- 待办事项更新：
  - [x] 解决路径适配问题
  - [x] 开发符号回归因子挖掘
  - [x] 实现参数网格搜索
  - [ ] 开发因子组合策略
  - [ ] 实现回测系统

### 问题与解决方案
1. 问题：符号回归因子在长时间周期上表现不佳
   - 解决：通过参数网格搜索发现最佳参数组合和预测周期
   
2. 问题：计算资源有限，网格搜索耗时长
   - 解决：
     - 实现中间结果保存，支持断点继续
     - 添加进度显示和日志记录
     - 可按需调整参数网格范围

### 想法与灵感
1. 可以考虑按时间段分别挖掘因子，然后进行组合
2. 添加因子多样性评估，避免高度相似因子重复选择
3. 考虑实现并行计算，提高网格搜索效率
4. 可视化工具展示不同参数组合的因子表现
5. 考虑加入强化学习方法自动调优参数

### 下一步计划
1. 完成参数网格搜索实验
2. 基于最佳参数组合开发实盘因子
3. 设计因子组合策略
4. 开始构建回测系统

### 2025-03-19 16:45:22
- 解决符号回归因子挖掘器早停问题：
  - 问题描述：遗传算法在启动后只执行了第0代就停止，无法完成全部迭代
  - 问题原因：
    1. `SymbolicRegressor`初始化时的`metric='spearman'`参数与`stopping_criteria`冲突
    2. 使用固定随机种子导致初始种群包含优秀个体提前触发停止条件
  - 解决方案：
    1. 移除`metric='spearman'`参数
    2. 确保使用合适的`stopping_criteria`值（设为0.001）
    3. 在回调函数中使用`abs()`处理适应度值，避免负值判断问题
  - 修改文件：
    - `factor_research/symbolic_miner.py`：修改回归器初始化参数
    - `scripts/grid_search_factors.py`：调整搜索参数
    - `tests/test_symbolic_mining.py`：修复测试用例

- 待办事项更新：
  - [x] 解决遗传算法早停问题
  - [ ] 运行完整的参数网格搜索
  - [ ] 基于搜索结果开发最佳因子模型
  - [ ] 开发因子组合策略

### 技术分析与发现
1. gplearn库的遗传算法实现中存在一些隐含的行为：
   - 当使用特定`metric`参数时，适应度计算方式会发生变化
   - 早停机制依赖于适应度评分和`stopping_criteria`的比较
   - 固定随机种子会导致每次运行生成相同的初始种群

2. 实验结果分析：
   - 修复早停问题后，算法能够正常执行多代进化
   - 各代适应度逐步提升，表明遗传算法正常工作
   - 最佳因子表达式随迭代次数增加而变得更加复杂和有效

### 下一步计划
1. 使用修复后的代码重新运行参数网格搜索
2. 分析不同参数组合对因子性能的影响
3. 选择最佳参数组合用于实盘因子生成
4. 开发因子组合和策略回测模块